<!DOCTYPE html>
<html>
  
  <head>
    
    <meta charset="utf-8">
    <title>Mortality Demo</title>

    <!-- load D3 library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <style type = 'text/css'>
    body { font-family: 'Helvetica Neue', Helvetica; font-weight: 300; padding: 20px;}
    th { text-align: left; }
    th, td { padding: 0 1em 0.5ex 0;}
    </style>

  </head>
  
  <body>


    <div>
      <svg id="viz_place" height="500" width="800" style="border: 1px solid grey;"></svg>
      <svg id="viz_activity" height="500" width="800" style="border: 1px solid grey;"></svg>
    </div>

    <script>


/*
 * Demo: Mortality 2008/2013
 * 
 */


/*
 * Call run when the page finishes loading
 *
 */
      
window.addEventListener("load",run);


function run () {
    
    var svg = d3.select("#viz_place");
    svg.append("text")
	.attr("id","loading")
	.attr("x",+svg.attr("width")/2)
	.attr("y",+svg.attr("height")/2)
	.attr("dy","0.35em")
	.style("text-anchor","middle")
	.text("loading data...");

    var svg2 = d3.select("#viz_activity");
    svg2.append("text")
    .attr("id","loading2")
    .attr("x",+svg.attr("width")/2)
    .attr("y",+svg.attr("height")/2)
    .attr("dy","0.35em")
    .style("text-anchor","middle")
    .text("loading data...");

    getData("",function(data) {
        createPlaceView(data);
        createActivityView(data);
    });
}

function getData (url, f) {

    d3.json("data")
    .header("Content-Type", "application/x-www-form-urlencoded")
    .get(
         function(error,data) {
         if (error) {
             d3.select("#loading").remove();
             d3.select("#loading2").remove();
             console.log(error);
         } else {
             d3.select("#loading").remove();
             d3.select("#loading2").remove();
             console.log(" data =", data);
             f(data["vizdata"]);
         }
         });
}

/*
 * Function for getting the total from the
 * data for a given manner and a given year
 * (returns 0 if there's no such entry in
 * the data)
 * 
 */
function getCountByColumn(data, column){
  columnData = {total: 0};
  data.forEach(function(row) {
    if (column in row) {
      if (row[column] in columnData){
        columnData[row[column]] += row.count;
      } else {
        columnData[row[column]] = row.count;
      }
      columnData.total += row.count
    }
  })
  return columnData;
}
function getColumnCountByYear(data, column){
  columnData = {};
  data.forEach(function(row){
    if (column in row) {
      if (row.year in columnData) {
        columnData[row.year].push({
          year: row.year,
          column: column,
          columnValue: row[column],
          count: row.count, 
          id: "mannerBar" + row.year + row[column]});
      } else {
        columnData[row.year] = [];
        columnData[row.year].push({
          year: row.year,
          column: column,
          columnValue: row[column],
          count: row.count,
          id: "mannerBar" + row.year + row[column]});
      }
    }
  })
  return columnData;
}

function createPlaceView(data){
    var svg = d3.select("#viz_place");
    var height = svg.attr("height");
    var width = svg.attr("width");

    // set chart-specific variables
    var margin = 15;
    var padding = 10;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var places = getCountByColumn(data, "place"); 

    var place_indices= d3.keys(places);
    place_indices.pop();
    
    var g = svg.selectAll("g")
    .data(place_indices)
    .enter()
    .append("g");

    g.append('image')
        .attr('xlink:href', function(d){console.log(d);return 'project4_icons-0'+d+'.png';})
        .attr('height', function(d){return +places[d];})
        .attr('width', function(d){return +places[d];})
        .attr('x', function(d,i){return i*chartWidth/place_indices.length + margin;})
        .attr('y', function(d,i){return ((i%2)+.5)*(chartHeight/2) + margin + padding;});

    g.append("text")
        .text(function(d){return PLACE[d];})
        .attr("x", function(d,i){return (i+.5)*chartWidth/place_indices.length + margin;})
        .attr("y", function(d,i){return (i%2)*(chartHeight/2) + margin;})        
        .style("text-anchor","middle")
        .style("font-family","sans-serif")
        .style("font-weight","bold")
        .style("font-size","16px")
        .style("fill", "#669999");
   
}
function createActivityView(data){
    var svg = d3.select("#viz_activity");
    var height = svg.attr("height");
    var width = svg.attr("width");

    // set chart-specific variables
    var margin = 15;
    var padding = 10;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var activities = getCountByColumn(data, "activity"); 

    var act_indices= d3.keys(activities);
    act_indices.pop();

    var g = svg.selectAll("g")
    .data(act_indices)
    .enter()
    .append("g");

   
    // g.selectAll("g")
    //     .data(activities)
    //     .enter()
    //     .append('image')
    //     .attr('xlink:href', function(d){return 'project4_icons-0'+d+'.png';})
    //     .attr('height', function(d){return +activities[d]/1000;})
    //     .attr('width', function(d){return +activities[d]/1000;})
    //     .attr('x', function(d,i){return (i+.5)*chartWidth/act_indices.length + margin;})
    //     .attr('y', function(d,i){return (i%2 +1)*(chartHeight/2) + margin + padding;});

    // g.selectAll("circle")
    //     .data(act_indices)
    //     .enter()
    g.append("circle")
        .attr("cx", function(d,i){return (i+.5)*chartWidth/act_indices.length + margin;})
        .attr("cy", function(d,i){return ((i%2) + .5)*(chartHeight/2) + margin + padding;})
        .attr("r", function(d){console.log(ACTIIVITY[d],activities[d]); return +activities[d];})
        .style("fill", "red")
        .style("opacity",".3");

    g.append("text")
        .text(function(d){return ACTIVITY[d];})
        .attr("x", function(d,i){return (i+.5)*chartWidth/act_indices.length + margin;})
        .attr("y", function(d,i){return (i%2)*(chartHeight/2) + margin;})        
        .style("text-anchor","middle")
        .style("font-family","sans-serif")
        .style("font-weight","bold")
        .style("font-size","12px")
        .style("fill", "#669999");
          
}

PLACE = {
    "0" : "Home",
    "1" : "Residential institution",
    "2" : "School, other institution and public administrative area",
    "3" : "Sports and athletics area",
    "4" : "Street and highway",
    "5" : "Trade and service area",
    "6" : "Industrial and construction area",
    "7" : "Farm",
    "8" : "Other Specified Places"
}
ACTIVITY= {
    "0":"While engaged in sports activity",
    "1":"While engaged in leisure activity",
    "2":"While working for income",
    "3":"While engaged in other types of work",
    "4":"While resting, sleeping, eating (vital activities)",
    "8":"While engaged in other specified activities",
    "9":"During unspecified activity"
}

    </script>
    
  </body>
  
</html>
